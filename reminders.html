import { useState } from "react";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { useQuery, useMutation, useQueryClient } from "@tanstack/react-query";
import { apiRequest } from "@/lib/queryClient";
import { useToast } from "@/hooks/use-toast";
import { MoreHorizontal, PlusIcon } from "lucide-react";
import { Dialog, DialogContent, DialogHeader, DialogTitle, DialogTrigger } from "@/components/ui/dialog";
import { DropdownMenu, DropdownMenuContent, DropdownMenuItem, DropdownMenuTrigger } from "@/components/ui/dropdown-menu";
import { z } from "zod";
import { useForm } from "react-hook-form";
import { zodResolver } from "@hookform/resolvers/zod";
import { Form, FormControl, FormDescription, FormField, FormItem, FormLabel, FormMessage } from "@/components/ui/form";
import { Input } from "@/components/ui/input";
import { Skeleton } from "@/components/ui/skeleton";
import { format } from "date-fns";
import { WaterIcon, MeditationIcon, MoodIcon } from "@/lib/icons";

const reminderFormSchema = z.object({
  title: z.string().min(1, "Title is required"),
  time: z.string().regex(/^([0-1]?[0-9]|2[0-3]):[0-5][0-9]$/, "Invalid time format. Use HH:MM"),
  iconName: z.string().optional(),
});

type ReminderFormValues = z.infer<typeof reminderFormSchema>;

export default function Reminders() {
  const [reminderFormOpen, setReminderFormOpen] = useState(false);
  const queryClient = useQueryClient();
  const { toast } = useToast();

  const { data: reminders, isLoading } = useQuery({
    queryKey: ['/api/reminders'],
  });

  const form = useForm<ReminderFormValues>({
    resolver: zodResolver(reminderFormSchema),
    defaultValues: {
      title: "",
      time: "09:00",
      iconName: "water",
    },
  });

  const createReminderMutation = useMutation({
    mutationFn: async (values: ReminderFormValues) => {
      // Convert time string to Date
      const [hours, minutes] = values.time.split(':').map(Number);
      const reminderTime = new Date();
      reminderTime.setHours(hours, minutes, 0, 0);
      
      return await apiRequest("POST", "/api/reminders", {
        ...values,
        time: reminderTime,
      });
    },
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['/api/reminders'] });
      setReminderFormOpen(false);
      form.reset();
      toast({
        title: "Reminder created",
        description: "Your reminder has been scheduled.",
      });
    },
    onError: (error) => {
      toast({
        title: "Failed to create reminder",
        description: error.message,
        variant: "destructive",
      });
    }
  });

  const deleteReminderMutation = useMutation({
    mutationFn: async (reminderId: number) => {
      return await apiRequest("DELETE", `/api/reminders/${reminderId}`, {});
    },
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['/api/reminders'] });
      toast({
        title: "Reminder deleted",
        description: "The reminder has been removed.",
      });
    },
    onError: (error) => {
      toast({
        title: "Failed to delete reminder",
        description: error.message,
        variant: "destructive",
      });
    }
  });

  const onSubmit = (values: ReminderFormValues) => {
    createReminderMutation.mutate(values);
  };

  const getIconComponent = (iconName: string) => {
    switch (iconName) {
      case "water": return <WaterIcon className="text-primary" />;
      case "meditation": return <MeditationIcon className="text-secondary" />;
      case "mood": return <MoodIcon className="text-accent" />;
      default: return <WaterIcon className="text-primary" />;
    }
  };

  const getIconBackgroundColor = (iconName: string) => {
    switch (iconName) {
      case "water": return "bg-primary bg-opacity-10";
      case "meditation": return "bg-secondary bg-opacity-10";
      case "mood": return "bg-accent bg-opacity-10";
      default: return "bg-primary bg-opacity-10";
    }
  };

  const formatReminderTime = (dateString: string) => {
    const date = new Date(dateString);
    const today = new Date();
    const tomorrow = new Date();
    tomorrow.setDate(today.getDate() + 1);
    
    let prefix = "";
    if (date.toDateString() === today.toDateString()) {
      prefix = "Today";
    } else if (date.toDateString() === tomorrow.toDateString()) {
      prefix = "Tomorrow";
    }
    
    return `${prefix}, ${format(date, "h:mm a")}`;
  };

  return (
    <Card>
      <CardHeader className="flex flex-row items-center justify-between pb-2">
        <CardTitle className="text-lg font-semibold">Upcoming Reminders</CardTitle>
        <Dialog open={reminderFormOpen} onOpenChange={setReminderFormOpen}>
          <DialogTrigger asChild>
            <Button variant="link" className="text-primary text-sm font-medium hover:no-underline p-0">Add New</Button>
          </DialogTrigger>
          <DialogContent>
            <DialogHeader>
              <DialogTitle>Create Reminder</DialogTitle>
            </DialogHeader>
            <Form {...form}>
              <form onSubmit={form.handleSubmit(onSubmit)} className="space-y-4">
                <FormField
                  control={form.control}
                  name="title"
                  render={({ field }) => (
                    <FormItem>
                      <FormLabel>Title</FormLabel>
                      <FormControl>
                        <Input placeholder="E.g., Drink water" {...field} />
                      </FormControl>
                      <FormMessage />
                    </FormItem>
                  )}
                />
                
                <FormField
                  control={form.control}
                  name="time"
                  render={({ field }) => (
                    <FormItem>
                      <FormLabel>Time</FormLabel>
                      <FormControl>
                        <Input type="time" {...field} />
                      </FormControl>
                      <FormDescription>Set a time for this reminder</FormDescription>
                      <FormMessage />
                    </FormItem>
                  )}
                />
                
                <FormField
                  control={form.control}
                  name="iconName"
                  render={({ field }) => (
                    <FormItem>
                      <FormLabel>Icon</FormLabel>
                      <div className="flex space-x-2">
                        <Button
                          type="button"
                          variant={field.value === "water" ? "secondary" : "outline"}
                          className="flex-1"
                          onClick={() => form.setValue("iconName", "water")}
                        >
                          <WaterIcon className="mr-2" /> Water
                        </Button>
                        <Button
                          type="button"
                          variant={field.value === "meditation" ? "secondary" : "outline"}
                          className="flex-1"
                          onClick={() => form.setValue("iconName", "meditation")}
                        >
                          <MeditationIcon className="mr-2" /> Meditation
                        </Button>
                        <Button
                          type="button"
                          variant={field.value === "mood" ? "secondary" : "outline"}
                          className="flex-1"
                          onClick={() => form.setValue("iconName", "mood")}
                        >
                          <MoodIcon className="mr-2" /> Mood
                        </Button>
                      </div>
                      <FormMessage />
                    </FormItem>
                  )}
                />
                
                <Button 
                  type="submit" 
                  className="w-full bg-primary hover:bg-primary-dark"
                  disabled={createReminderMutation.isPending}
                >
                  {createReminderMutation.isPending ? "Creating..." : "Create Reminder"}
                </Button>
              </form>
            </Form>
          </DialogContent>
        </Dialog>
      </CardHeader>
      <CardContent>
        <div className="space-y-3">
          {isLoading && (
            Array(3).fill(0).map((_, i) => (
              <div key={i} className="flex items-center p-3 border border-neutral-200 rounded-lg">
                <Skeleton className="w-10 h-10 rounded-full mr-3" />
                <div className="flex-1">
                  <Skeleton className="h-5 w-2/3 mb-1" />
                  <Skeleton className="h-3 w-1/3" />
                </div>
                <Skeleton className="w-6 h-6" />
              </div>
            ))
          )}

          {reminders && reminders.length > 0 && reminders.map((reminder) => (
            <div key={reminder.id} className="flex items-center p-3 border border-neutral-200 rounded-lg">
              <div className={`w-10 h-10 rounded-full ${getIconBackgroundColor(reminder.iconName)} flex items-center justify-center mr-3`}>
                {getIconComponent(reminder.iconName)}
              </div>
              <div className="flex-1">
                <h3 className="font-medium text-neutral-800">{reminder.title}</h3>
                <p className="text-xs text-neutral-500">{formatReminderTime(reminder.time)}</p>
              </div>
              <DropdownMenu>
                <DropdownMenuTrigger asChild>
                  <Button variant="ghost" size="icon" className="text-neutral-400 hover:text-primary">
                    <MoreHorizontal className="h-4 w-4" />
                  </Button>
                </DropdownMenuTrigger>
                <DropdownMenuContent align="end">
                  <DropdownMenuItem
                    className="text-destructive focus:text-destructive"
                    onClick={() => deleteReminderMutation.mutate(reminder.id)}
                  >
                    Delete
                  </DropdownMenuItem>
                </DropdownMenuContent>
              </DropdownMenu>
            </div>
          ))}
          
          {reminders && reminders.length === 0 && (
            <div className="text-center py-4 text-neutral-500">
              No reminders scheduled. Add your first reminder!
            </div>
          )}
        </div>
      </CardContent>
    </Card>
  );
}
